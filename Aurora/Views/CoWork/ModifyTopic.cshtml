
@{
    ViewBag.Title = "Modify Topic";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var iconarray = new List<string>();
    iconarray.Add("glyphicon-pencil");
    iconarray.Add("glyphicon-star");
    iconarray.Add("glyphicon-th-list");
    iconarray.Add("glyphicon-blackboard");
    var idx = 0;
}


<script src="../../ckeditor/ckeditor.js"></script>
<link href="~/Scripts/jquery-autocomplete/jquery.auto-complete.css" rel="stylesheet" type="text/css" />
<script src="~/Scripts/jquery-autocomplete/jquery.auto-complete.min.js" type="text/javascript"></script>
<script src="~/Scripts/Aurora.js" type="text/javascript"></script>
<script src="~/Scripts/jquery.base64.js" type="text/javascript"></script>

<link href="~/Content/videorecorder.css" rel="stylesheet" type="text/css" />

<script type="text/javascript">
    $(function(){
        Aurora.createpageinit();
    })
</script>

<div class="newcontainer">
    <hr style="color:grey;margin-top:1px;margin-bottom:1px;border: 1px solid;border-color:grey" />
    <nav class="col-sm-2 nav-sidebar">
        <ul class="nav">
            <li class="cursor-pointer nav-sidebar-icon">
                <span class="glyphicon glyphicon-menu-hamburger sidebar-show"></span>
            </li>
            @foreach (var item in ViewBag.NavList)
            {
                if (idx == 0)
                {
                    <li class="activenavitem active" navid="@item">
                        <a href="">
                            <span class="glyphicon @(iconarray[idx%4])" data-toggle="tooltip" title="@item"></span>
                            <span class="item-show">@item</span>
                        </a>
                    </li>
                }
                else
                {
                    <li navid="@item">
                        <a href="/CoWork/Home?activenavitem=@item">
                            <span class="glyphicon @(iconarray[idx%4])" data-toggle="tooltip" title="@item"></span>
                            <span class="item-show">@item</span>
                        </a>
                    </li>
                }

                idx = idx + 1;
            }
        </ul>
    </nav>

    <div class="col-sm-9 create-editor-div">
        @using (Html.BeginForm("ModifyTopicPost", "CoWork", FormMethod.Post, new { enctype = "multipart/form-data" }))
        {
            @Html.ValidationSummary(true, "", new { @class = "text-danger" })

            <div class="form-group">

                @*<div class="mdeditor-op">
                    <span class="glyphicon glyphicon-paperclip maineditor-attach btn-file" data-toggle="tooltip" title="choose attachment" style="height:40px;width:40px;text-align:center;font-weight:bold;font-size:28px;">
                        <input class="btn-available" type="file" name="file1" id="file1" runat="server" onchange="ShowFileNamex(this)" />
                    </span>
                </div>*@
                <textarea name="JobTopicEditor" id="JobTopicEditor" rows="50" cols="80">@(ViewBag.tcontent)</textarea>
                <script>
                    CKEDITOR.replace('JobTopicEditor', { htmlEncodeOutput: true, skin: 'moono-lisa',height:'360px' });
                </script>

            </div>

            <div class="form-group">
                <div class="row">

                    <div class="col-xs-2">
                        <input type="submit" class="form-control btn btn-success" value="Submit">
                    </div>
                    <div class="col-xs-10">
                        <input id="navid" name="navid" value="@(ViewBag.activenavitem)" type="hidden">
                        <input id="topicid" name="topicid" value="@(ViewBag.topicid)" type="hidden">
                        <input id="commentid" name="commentid" value="@(ViewBag.commentid)" type="hidden">
                    </div>

                    <script type="text/javascript">
                    function ShowFileNamex(oFile) {
                                ajaxFileUploadx();
                            }
                    function ajaxFileUploadx() {
                        $.ajaxFileUpload
                        (
                            {
                                url: '/userfiles/ImageUpload.ashx',
                                secureuri: false,
                                fileElementId: 'file1',
                                dataType: 'HTML',
                                success: function (data, status)
                                {
                                    var wholeval = CKEDITOR.instances.JobTopicEditor.getData() + data;
                                    CKEDITOR.instances.JobTopicEditor.setData(wholeval);
                                },
                                error: function (e)
                                {
                                    alert(e);
                                }
                            }
                        )
                        return false;
                    }
                    </script>
                </div>
            </div>
        }
    </div>

    <div class="col-sm-1 create-tool-div">
        <div class="create-tool-item maineditor-attach" data-toggle="tooltip" title="Add Attachment">
            <span class="glyphicon glyphicon-paperclip maineditor-attach-icon btn-file" style="text-align:center;">
                <input class="btn-available" type="file" name="file1" id="file1" runat="server" onchange="ShowFileNamex(this)" />
            </span>
        </div>
        <div class="create-tool-item maineditor-video" data-toggle="tooltip" title="Record Video">
            <span class="glyphicon glyphicon-facetime-video maineditor-video-icon" style="text-align:center;">
            </span>
        </div>
    </div>



    
    <script src="~/Scripts/VideoRecorderJs-master/dist/VideoRecorderJS.min.js" type="text/javascript"></script>


    <div id="modal-video" class="modal fade" tabindex="-1" role="dialog">
        <div class="modal-dialog m-video" role="document">
            <div class="modal-content">
                <div class="modal-body m-video-body">
                    <div class="m-video-header">
                        <button type="button" class="video-close" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    </div>
                    <div class="m-video-container">
                        <video id="m-video-record" class=""></video>
                        <video id="m-video-play" class="hidden"></video>
                    </div>
                    <div class="m-video-footer">
                        <div class="mc-start">
                            <label class="m-video-start m-video-op" data-val="start"></label>
                        </div>
                        <div class="mc-end hidden">
                            <label class="m-video-end m-video-op" data-val="end"></label>
                        </div>
                        <div class="mc-play hidden">
                            <span class="glyphicon glyphicon-play m-video-op" id="m-play" data-val="play"></span>
                            <span class="glyphicon glyphicon-pause m-video-op hidden" id="m-pause" data-val="pause"></span>
                            <span class="glyphicon glyphicon-upload m-video-op" id="m-upload" data-val="upload"></span>
                        </div>
                        <span style="font-size:20px;float:right" id="countdown"></span>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <script type="text/javascript">

    $(function(){
        var virec = null;
        var videoblob = null;
        var countdowntime = 60;
        var functioncalltime = 0;
        var timerInterval = null;

        $('body').on('click', '.maineditor-video', function () {
            $("#m-video-play").addClass('hidden');
            $("#m-video-record").removeClass('hidden');

            $(".mc-end").addClass('hidden');
            $(".mc-play").addClass('hidden');
            $(".mc-start").removeClass('hidden');

            $('#modal-video').modal('show');

            if (virec === null) {
                virec = new VideoRecorderJS.init(
                {
                    resize: 0.8, // recorded video dimentions are 0.4 times smaller than the original
                    webpquality: 0.5, // chrome and opera support webp imags, this is about the aulity of a frame
                    framerate: 30,  // recording frame rate
                    videotagid: "m-video-record",
                    videoWidth: "640",
                    videoHeight: "480",
                    log: true,
                    workerPath: "../../Scripts/VideoRecorderJs-master/dist/recorderWorker.js"
                },
                function () {
                    //success callback. this will fire if browsers supports
                },
                function (err) {
                    //onerror callback, this will fire for mediaErrors
                    if (err.name == "BROWSER_NOT_SUPPORTED") {
                        //handler code goes here
                    } else if (err.name == "PermissionDeniedError") {
                        //handler code goes here
                    } else if (err.name == "NotFoundError") {
                        //handler code goes here
                    } else {
                        throw 'Unidentified Error.....';
                    }

                }
                );
            }
        })

        $('body').on('click', '.video-close', function () {
            $('#modal-video').modal('hide');
            if (virec)
            {
                virec.clearRecording();
                stopCountDown();
            }
        })

        $('body').on('click', '.m-video-op', function(){
            $('.m-video-op').parent().addClass('hidden');
            if($(this).attr('data-val') == 'start'){
                //start record
                 virec.startCapture();
                 stopCountDown();
                 startCountDown();
                $('.mc-end').removeClass('hidden');
            }
            else if($(this).attr('data-val') == 'end'){
                //stop record
                 virec.stopCapture(oncaptureFinish);
                 stopCountDown();
                $('#m-video-record').addClass('hidden');
                $('#m-video-play').removeClass('hidden');
                $('.mc-play').removeClass('hidden');
                $('#m-play').removeClass('hidden');
                $('#m-pause').addClass('hidden');
            }
            else if($(this).attr('data-val') == 'upload'){
                //upload record
                if (videoblob) {

                    var fd = new FormData();
                    fd.append('fname', 'myvideo.webm');
                    fd.append('data', videoblob);

                    $.ajax({
                        type: 'POST',
                        url: '/CoWork/UploadVideoData',
                        data: fd,
                        processData: false,
                        contentType: false
                    }).done(function (output) {
                        var wholeval = CKEDITOR.instances.JobTopicEditor.getData() + output.data;
                        CKEDITOR.instances.JobTopicEditor.setData(wholeval);

                        if (virec) {
                            virec.clearRecording();
                            stopCountDown();
                        }

                        $('.mc-start').removeClass('hidden');
                        $('#m-video-record').removeClass('hidden');
                        $('#m-video-play').addClass('hidden');
                        $('#m-video-play').attr('src', '');
                    });
                }

            }
            else if($(this).attr('data-val') == 'play'){
                //play record
                $('.mc-play').removeClass('hidden');
                $('#m-play').addClass('hidden');
                $('#m-pause').removeClass('hidden');
                virec.play();
            }
            else if($(this).attr('data-val') == 'pause'){
                $('.mc-play').removeClass('hidden');
                $('#m-play').removeClass('hidden');
                $('#m-pause').addClass('hidden');
            }

        })
    })


    function oncaptureFinish(result) {
        result.forEach(function (item) {
            if (item.type == "video") {
                videoblob = item.blob;
                var videobase64 = window.URL.createObjectURL(videoblob);
                document.getElementById('m-video-play').src = videobase64;
            }
        });
    }

    function setCountDownTime(time) {
        countdownElement.innerHTML = time;
        return time;
    }


    function startCountDown() {
        if (timerInterval == null) {
            functioncalltime = countdowntime;
            var value = setCountDownTime(functioncalltime);
            timerInterval = setInterval(function () {
                var value = setCountDownTime(--functioncalltime);
                if (value == 0) {
                    clearInterval(timerInterval);
                    virec.stopCapture(oncaptureFinish);
                }
            }, 1000);
        }
    }

    function stopCountDown() {
        if (timerInterval) {
            clearInterval(timerInterval);
            timerInterval = null;
        }
    }
    </script>


</div>


